<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Storage V2 DApp - Blockchain Smart Contract</title>
    <style>
        /* (Your original CSS remains unchanged for brevity) */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
        .container { max-width: 900px; margin: 0 auto; background: white; border-radius: 15px; box-shadow: 0 20px 40px rgba(0,0,0,0.1); overflow: hidden; }
        /* ... (Rest of your CSS here, omitted for space) ... */
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🚀 Storage V2 DApp</h1>
            <p>Decentralized Storage Smart Contract on GIWA Sepolia Testnet</p>
        </div>
        
        <div class="content">
            <div class="library-status" id="libraryStatus">📚 Initializing DApp...</div>
            
            <div class="network-info">
                <strong>⚠️ Make sure you're connected to GIWA Sepolia Testnet!</strong>
            </div>
            
            <div class="section">
                <h3>📊 Contract Information</h3>
                <div class="info-grid">
                    <!-- Your original info grid -->
                </div>
                
                <button onclick="connectWallet()" id="connectBtn">🔗 Connect Wallet</button>
                <button onclick="refreshData()" id="refreshBtn" disabled>🔄 Refresh Data</button>
            </div>
            
            <!-- Rest of your sections remain the same -->
            
            <div class="footer">
                <p>Built with ❤️ using Solidity, Ethers.js, and Web3Modal on GIWA Sepolia Testnet</p>
                <p>Contract Address: <code>0x61123b7a22d2f1b8c2c4becc8333e8e4209cce28</code></p>
            </div>
        </div>
    </div>

    <!-- Load libraries -->
    <script src="https://cdn.jsdelivr.net/npm/ethers@5/dist/ethers.umd.min.js"></script> <!-- Updated ethers.js source -->
    <script src="https://unpkg.com/web3modal@1.9.11/dist/web3modal.min.js"></script> <!-- Web3Modal for multi-wallet support -->
    <script src="https://unpkg.com/@walletconnect/web3-provider@1.8.0/dist/umd/index.min.js"></script> <!-- Required for Web3Modal -->

    <script>
        // Wait for DOM and libraries to load
        document.addEventListener('DOMContentLoaded', async function() {
            if (typeof ethers === 'undefined' || typeof Web3Modal === 'undefined') {
                document.getElementById('libraryStatus').innerHTML = '❌ Failed to load libraries. Please refresh the page or check your internet connection.';
                document.getElementById('libraryStatus').className = 'library-status error'; // Assuming you add a .error class in CSS
                return;
            }
            
            document.getElementById('libraryStatus').innerHTML = '✅ Libraries loaded successfully!';
            document.getElementById('libraryStatus').className = 'library-status success'; // Update CSS as needed
            initializeApp();
        });

        let provider, signer, contract, userAddress, web3Modal, isConnected = false;
        const CONTRACT_ADDRESS = "0x61123b7a22d2f1b8c2c4becc8333e8e4209cce28";
        const ABI = [ /* Your original ABI array */ ];
        const GIWA_SEPOLIA_CHAIN_ID = 107081; // Decimal for clarity

        async function initializeApp() {
            web3Modal = new Web3Modal({
                network: 'custom', // Generic for EVM chains
                cacheProvider: true,
                providerOptions: {
                    walletconnect: {
                        package: window.WalletConnectProvider,
                        options: {
                            infuraId: "YOUR_INFURA_ID" // Add your Infura ID here for WalletConnect; optional but recommended
                        }
                    },
                    // Web3Modal auto-detects MetaMask, Rabby, etc.
                }
            });
            // Rest of your init can go here if needed
        }

        async function connectWallet() {
            try {
                const instance = await web3Modal.connect();
                provider = new ethers.providers.Web3Provider(instance);
                signer = provider.getSigner();
                userAddress = await signer.getAddress();
                
                const network = await provider.getNetwork();
                if (network.chainId !== GIWA_SEPOLIA_CHAIN_ID) {
                    showStatus('⚠️ Please switch to GIWA Sepolia Testnet (Chain ID: 107081)', 'warning', 'storeStatus');
                    await switchNetwork(); // Updated to handle via provider
                    return;
                }
                
                contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, provider);
                document.getElementById('userAddress').textContent = userAddress;
                document.getElementById('connectBtn').textContent = '✅ Connected';
                document.getElementById('connectBtn').disabled = true;
                enableButtons();
                isConnected = true;
                await refreshData();
                showStatus('Wallet connected successfully! 🎉', 'success', 'storeStatus');
                
            } catch (error) {
                console.error('Connection error:', error);
                showStatus('Failed to connect wallet: ' + error.message, 'error', 'storeStatus');
            }
        }

        async function switchNetwork() {
            try {
                await provider.provider.request({
                    method: 'wallet_switchEthereumChain',
                    params: [{ chainId: '0x1A249' }] // Hex for 107081
                });
                connectWallet(); // Retry after switch
            } catch (error) {
                showStatus('Failed to switch network: ' + error.message, 'error', 'storeStatus');
            }
        }

        // The rest of your functions (refreshData, storeValue, etc.) can remain largely the same,
        // as they use the provider and signer setup above. Just ensure they check if provider exists.

        function enableButtons() {
            // Your original function
        }

        function showStatus(message, type, elementId) {
            // Your original function
        }

        // Add event listeners for Web3Modal
        if (web3Modal) {
            web3Modal.on('disconnect', () => {
                isConnected = false;
                location.reload(); // Or handle disconnection gracefully
            });
        }
    </script>
</body>
</html>

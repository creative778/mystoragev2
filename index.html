<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Storage V2 DApp ‚Äì Giwa Sepolia</title>
    <style>
        /* =====  SAME STYLES AS BEFORE  ===== */
        *{margin:0;padding:0;box-sizing:border-box}body{font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;
        background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;padding:20px}
        .container{max-width:900px;margin:0 auto;background:#fff;border-radius:15px;box-shadow:0 20px 40px rgba(0,0,0,.1);overflow:hidden}
        .header{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;padding:30px;text-align:center}
        .header h1{font-size:2.5em;margin-bottom:10px}.header p{opacity:.9;font-size:1.1em}
        .content{padding:30px}.section{background:#f8f9fa;border-radius:10px;padding:25px;margin-bottom:20px;border-left:4px solid #667eea}
        .section h3{color:#333;margin-bottom:15px;font-size:1.3em}.info-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:15px;margin-bottom:20px}
        .info-item{background:#fff;padding:15px;border-radius:8px;border:1px solid #e9ecef}
        .info-item strong{color:#667eea;display:block;margin-bottom:5px}.info-item span{word-break:break-all;font-family:'Courier New',monospace;font-size:.9em}
        input{width:100%;padding:12px 15px;border:2px solid #e9ecef;border-radius:8px;font-size:16px;margin-bottom:15px;transition:border-color .3s}
        input:focus{outline:none;border-color:#667eea}button{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;border:none;padding:12px 25px;border-radius:8px;font-size:16px;cursor:pointer;transition:transform .2s,box-shadow .2s;margin-right:10px;margin-bottom:10px}
        button:hover{transform:translateY(-2px);box-shadow:0 5px 15px rgba(102,126,234,.4)}button:disabled{background:#6c757d;cursor:not-allowed;transform:none;box-shadow:none}
        .status{padding:12px;border-radius:8px;margin-top:15px;font-weight:500}.success{background:#d4edda;color:#155724;border:1px solid #c3e6cb}
        .error{background:#f8d7da;color:#721c24;border:1px solid #f5c6cb}.info{background:#d1ecf1;color:#0c5460;border:1px solid #bee5eb}
        .warning{background:#fff3cd;color:#856404;border:1px solid #ffeaa7}.event-item{background:#fff;border:1px solid #e9ecef;border-radius:8px;padding:15px;margin-bottom:10px}
        .event-item h5{color:#667eea;margin-bottom:10px}.network-info{background:linear-gradient(135deg,#ffeaa7 0%,#fab1a0 100%);color:#2d3436;padding:15px;border-radius:8px;margin-bottom:20px;text-align:center}
        .library-status{background:#e7f3ff;padding:15px;border-radius:8px;margin-bottom:20px;text-align:center;font-weight:bold}
        .wallet-buttons{display:flex;flex-wrap:wrap;gap:10px;margin-bottom:15px}.wallet-btn{background:#fff;color:#333;border:2px solid #667eea;padding:10px 20px;border-radius:8px;font-size:14px;cursor:pointer;transition:all .2s;display:flex;align-items:center;gap:8px}
        .wallet-btn:hover{background:#667eea;color:#fff;transform:translateY(-1px)}.wallet-btn.connected{background:#d4edda;border-color:#28a745;color:#155724}
        .footer{background:#f8f9fa;padding:20px;text-align:center;color:#6c757d;border-top:1px solid #e9ecef}
        @media (max-width:768px){.container{margin:10px;border-radius:10px}.header{padding:20px}.header h1{font-size:2em}.content{padding:20px}.section{padding:20px}.wallet-buttons{flex-direction:column}}
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöÄ Storage V2 DApp</h1>
            <p>Decentralized Storage Smart Contract on Giwa Sepolia Testnet</p>
        </div>

        <div class="content">
            <div class="library-status" id="libraryStatus">üìö Initialising DApp‚Ä¶</div>

            <div class="network-info">
                <strong>‚ö†Ô∏è Make sure you‚Äôre on Giwa Sepolia Testnet (Chain-ID 91342)</strong>
            </div>

            <div class="section">
                <h3>üìä Contract Information</h3>
                <div class="info-grid">
                    <div class="info-item"><strong>Contract Address:</strong><span id="contractAddr">0x61123b7a22d2f1b8c2c4becc8333e8e4209cce28</span></div>
                    <div class="info-item"><strong>Current Stored Value:</strong><span id="currentValue">Not connected</span></div>
                    <div class="info-item"><strong>Contract Owner:</strong><span id="contractOwner">Not connected</span></div>
                    <div class="info-item"><strong>Your Address:</strong><span id="userAddress">Not connected</span></div>
                    <div class="info-item"><strong>Are you the owner?</strong><span id="isOwner">Unknown</span></div>
                    <div class="info-item"><strong>Network:</strong><span id="networkName">Not connected</span></div>
                    <div class="info-item"><strong>Connected Wallet:</strong><span id="connectedWallet">None</span></div>
                </div>

                <h4 style="margin-bottom:10px">Connect Your Wallet:</h4>
                <div class="wallet-buttons">
                    <button class="wallet-btn" onclick="connectWallet('metamask')" id="metamaskBtn">ü¶ä MetaMask</button>
                    <button class="wallet-btn" onclick="connectWallet('rabby')" id="rabbyBtn">üê∞ Rabby</button>
                    <button class="wallet-btn" onclick="connectWallet('coinbase')" id="coinbaseBtn">üîµ Coinbase Wallet</button>
                    <button class="wallet-btn" onclick="connectWallet('walletconnect')" id="walletconnectBtn">üì± WalletConnect</button>
                    <button class="wallet-btn" onclick="connectWallet('auto')" id="autoBtn">üîó Auto-detect</button>
                </div>

                <button onclick="refreshData()" id="refreshBtn" disabled>üîÑ Refresh Data</button>
                <button onclick="disconnectWallet()" id="disconnectBtn" disabled>‚ùå Disconnect</button>
            </div>

            <div class="section">
                <h3>üíæ Store New Value</h3>
                <p style="margin-bottom:15px;color:#6c757d">Only the contract owner can store values.</p>
                <input type="number" id="storeInput" placeholder="Enter any number (e.g. 42)">
                <button onclick="storeValue()" id="storeBtn" disabled>üíæ Store Value</button>
                <div id="storeStatus"></div>
            </div>

            <div class="section">
                <h3>üëë Transfer Ownership</h3>
                <p style="margin-bottom:15px;color:#6c757d">Transfer contract ownership to another address.</p>
                <input type="text" id="newOwnerInput" placeholder="New owner address (0x‚Ä¶)">
                <button onclick="transferOwnership()" id="transferBtn" disabled>üëë Transfer Ownership</button>
                <div id="transferStatus"></div>
            </div>

            <div class="section">
                <h3>üìú Recent Storage Events</h3>
                <button onclick="getEvents()" id="eventsBtn" disabled>üìú Load Recent Events</button>
                <div id="events"></div>
            </div>

            <div class="section">
                <h3>üîß Contract Functions</h3>
                <button onclick="testRetrieve()" id="retrieveBtn" disabled>üìñ Call retrieve()</button>
                <button onclick="testNumber()" id="numberBtn" disabled>üî¢ Call number()</button>
                <button onclick="testOwner()" id="ownerBtn" disabled>üë§ Call owner()</button>
                <button onclick="testGetContractInfo()" id="infoBtn" disabled>‚ÑπÔ∏è Call getContractInfo()</button>
                <div id="functionResults"></div>
            </div>
        </div>

        <div class="footer">
            <p>Built with ‚ù§Ô∏è using Solidity, Ethers.js, and deployed on Giwa Sepolia Testnet</p>
            <p>Contract: <code>0x61123b7a22d2f1b8c2c4becc8333e8e4209cce28</code></p>
        </div>
    </div>

    <script>
        /* =====  CDN LIST FOR ETHERS  ===== */
        const ethersCDNs = [
            'https://cdn.ethers.io/lib/ethers-5.7.2.umd.min.js',
            'https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js',
            'https://unpkg.com/ethers@5.7.2/dist/ethers.umd.min.js',
            'https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js'
        ];
        let currentCDNIndex = 0;

        function loadEthers() {
            return new Promise((resolve, reject) => {
                if (typeof window.ethers !== 'undefined') { resolve(); return; }
                const script = document.createElement('script');
                script.src = ethersCDNs[currentCDNIndex];
                script.onload = () => (typeof window.ethers !== 'undefined' ? resolve() : tryNextCDN(resolve, reject));
                script.onerror = () => tryNextCDN(resolve, reject);
                document.head.appendChild(script);
                setTimeout(() => { if (typeof window.ethers === 'undefined') tryNextCDN(resolve, reject); }, 5000);
            });
        }
        function tryNextCDN(resolve, reject) {
            currentCDNIndex++;
            currentCDNIndex < ethersCDNs.length ? loadEthers().then(resolve).catch(reject) : reject(new Error('Failed to load ethers.js from all CDNs'));
        }

        /* =====  GLOBAL VARS  ===== */
        let provider, signer, contract, userAddress, isConnected = false, connectedWalletType = '';
        const CONTRACT_ADDRESS = '0x61123b7a22d2f1b8c2c4becc8333e8e4209cce28';
        const GIWA_SEPOLIA_CHAIN_ID = 91342; // <<<<<  NUMBER  >>>>>

        const ABI = [
            'function store(uint256 num)',
            'function retrieve() view returns (uint256)',
            'function number() view returns (uint256)',
            'function owner() view returns (address)',
            'function transferOwnership(address newOwner)',
            'function getContractInfo() view returns (uint256,address,uint256)',
            'event NumberStored(uint256 indexed newValue,address indexed setter,uint256 timestamp)'
        ];

        /* =====  INITIALISATION  ===== */
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                document.getElementById('libraryStatus').textContent = 'üìö Loading Ethers.js‚Ä¶';
                await loadEthers();
                document.getElementById('libraryStatus').innerHTML = '‚úÖ Ethers.js loaded!';
                document.getElementById('libraryStatus').className = 'library-status success';
                initialiseApp();
            } catch (e) {
                document.getElementById('libraryStatus').innerHTML = '‚ùå Could not load Ethers.js<br><small>Refresh the page or check your connection.</small>';
                document.getElementById('libraryStatus').className = 'library-status error';
            }
        });

        async function initialiseApp() {
            if (await isAnyWalletConnected()) await connectWallet('auto');
        }
        async function isAnyWalletConnected() {
            try { return typeof window.ethereum !== 'undefined' && (await window.ethereum.request({ method: 'eth_accounts' })).length > 0; } catch { return false; }
        }

        /* =====  WALLET CONNECTION  ===== */
        async function connectWallet(walletType = 'auto') {
            try {
                if (typeof window.ethereum === 'undefined') { showStatus('No wallet detected. Install MetaMask / Rabby etc.', 'error', 'storeStatus'); return; }
                if (typeof ethers === 'undefined') { showStatus('Ethers.js not loaded. Refresh.', 'error', 'storeStatus'); return; }

                showStatus('Connecting‚Ä¶', 'info', 'storeStatus');
                await window.ethereum.request({ method: 'eth_requestAccounts' });

                provider = new ethers.providers.Web3Provider(window.ethereum);
                signer = provider.getSigner();
                userAddress = await signer.getAddress();
                connectedWalletType = detectWalletType();

                const network = await provider.getNetwork();
                document.getElementById('networkName').textContent = network.chainId === GIWA_SEPOLIA_CHAIN_ID ? 'Giwa Sepolia' : `Chain ${network.chainId}`;
                if (network.chainId !== GIWA_SEPOLIA_CHAIN_ID) { await switchToGiwaSepolia(); return; }

                contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, provider);
                document.getElementById('userAddress').textContent = userAddress;
                document.getElementById('connectedWallet').textContent = connectedWalletType;
                updateWalletButtons(connectedWalletType);
                enableButtons(); isConnected = true;
                await refreshData();
                showStatus(`${connectedWalletType} connected üéâ`, 'success', 'storeStatus');
            } catch (e) {
                console.error(e);
                if (e.code === 4001) showStatus('Connection cancelled', 'warning', 'storeStatus');
                else showStatus('Connection failed: ' + e.message, 'error', 'storeStatus');
            }
        }

        function detectWalletType() {
            if (typeof window.ethereum === 'undefined') return 'No Wallet';
            if (window.ethereum.isRabby) return 'Rabby';
            if (window.ethereum.isMetaMask) return 'MetaMask';
            if (window.ethereum.isCoinbaseWallet) return 'Coinbase Wallet';
            if (window.ethereum.isWalletConnect) return 'WalletConnect';
            return 'Unknown Wallet';
        }
        function updateWalletButtons(connected) {
            document.querySelectorAll('.wallet-btn').forEach(b => b.classList.remove('connected'));
            if (connected.toLowerCase().includes('metamask')) document.getElementById('metamaskBtn').classList.add('connected');
            if (connected.toLowerCase().includes('rabby')) document.getElementById('rabbyBtn').classList.add('connected');
            if (connected.toLowerCase().includes('coinbase')) document.getElementById('coinbaseBtn').classList.add('connected');
        }
        async function disconnectWallet() {
            provider = signer = contract = null; userAddress = ''; isConnected = false; connectedWalletType = '';
            document.getElementById('userAddress').textContent = 'Not connected';
            document.getElementById('connectedWallet').textContent = 'None';
            document.getElementById('currentValue').textContent = 'Not connected';
            document.getElementById('contractOwner').textContent = 'Not connected';
            document.getElementById('isOwner').textContent = 'Unknown';
            document.getElementById('networkName').textContent = 'Not connected';
            document.querySelectorAll('.wallet-btn').forEach(b => b.classList.remove('connected'));
            disableButtons();
            showStatus('Wallet disconnected', 'info', 'storeStatus');
        }
        async function switchToGiwaSepolia() {
            const hexChainId = '0x' + GIWA_SEPOLIA_CHAIN_ID.toString(16);
            try {
                await window.ethereum.request({ method: 'wallet_switchEthereumChain', params: [{ chainId: hexChainId }] });
                setTimeout(() => connectWallet('auto'), 1000);
            } catch (e) {
                if (e.code === 4902) {
                    await window.ethereum.request({
                        method: 'wallet_addEthereumChain',
                        params: [{
                            chainId: hexChainId,
                            chainName: 'Giwa Sepolia Testnet',
                            nativeCurrency: { name: 'ETH', symbol: 'ETH', decimals: 18 },
                            rpcUrls: ['https://sepolia-rpc.giwa.io'],
                            blockExplorerUrls: ['https://sepolia-explorer.giwa.io']
                        }]
                    });
                    setTimeout(() => connectWallet('auto'), 1000);
                } else { showStatus('Could not switch network: ' + e.message, 'error', 'storeStatus'); }
            }
        }
        function enableButtons() {
            ['refreshBtn', 'disconnectBtn', 'storeBtn', 'transferBtn', 'eventsBtn', 'retrieveBtn', 'numberBtn', 'ownerBtn', 'infoBtn'].forEach(id => { const b = document.getElementById(id); if (b) b.disabled = false; });
        }
        function disableButtons() {
            ['refreshBtn', 'disconnectBtn', 'storeBtn', 'transferBtn', 'eventsBtn', 'retrieveBtn', 'numberBtn', 'ownerBtn', 'infoBtn'].forEach(id => { const b = document.getElementById(id); if (b) b.disabled = true; });
        }

        /* =====  CORE FUNCTIONS  ===== */
        async function refreshData() {
            if (!isConnected || !contract) { showStatus('Connect wallet first', 'error', 'storeStatus'); return; }
            try {
                showStatus('Loading data‚Ä¶', 'info', 'storeStatus');
                const [val, owner] = await Promise.all([contract.number(), contract.owner()]);
                const ownerBool = userAddress && userAddress.toLowerCase() === owner.toLowerCase();
                document.getElementById('currentValue').textContent = val.toString();
                document.getElementById('contractOwner').textContent = owner;
                document.getElementById('isOwner').textContent = ownerBool ? 'Yes ‚úÖ' : 'No ‚ùå';
                showStatus('Data refreshed ‚úÖ', 'success', 'storeStatus');
            } catch (e) {
                showStatus('Refresh failed: ' + e.message, 'error', 'storeStatus');
            }
        }
        async function storeValue() {
            if (!isConnected || !signer) { showStatus('Connect wallet first', 'error', 'storeStatus'); return; }
            const val = document.getElementById('storeInput').value.trim();
            if (!val || isNaN(val)) { showStatus('Enter a valid number', 'error', 'storeStatus'); return; }
            try {
                showStatus(`Confirm in ${connectedWalletType}‚Ä¶`, 'info', 'storeStatus');
                const tx = await contract.connect(signer).store(val);
                showStatus(`Tx sent: ${tx.hash}`, 'info', 'storeStatus');
                const rcpt = await tx.wait();
                showStatus(`‚úÖ Value ${val} stored in block ${rcpt.blockNumber}`, 'success', 'storeStatus');
                document.getElementById('storeInput').value = '';
                await refreshData();
            } catch (e) {
                if (e.message.includes('Only owner')) showStatus('‚ùå Only owner can store', 'error', 'storeStatus');
                else if (e.code === 4001) showStatus('Tx cancelled', 'warning', 'storeStatus');
                else showStatus('Tx failed: ' + e.message, 'error', 'storeStatus');
            }
        }
        async function transferOwnership() {
            if (!isConnected || !signer) { showStatus('Connect wallet first', 'error', 'transferStatus'); return; }
            const addr = document.getElementById('newOwnerInput').value.trim();
            if (!addr) { showStatus('Enter new owner address', 'error', 'transferStatus'); return; }
            if (!ethers.utils.isAddress(addr)) { showStatus('Invalid address', 'error', 'transferStatus'); return; }
            if (!confirm(`Transfer ownership to ${addr}? Cannot be undone!`)) return;
            try {
                showStatus(`Confirm in ${connectedWalletType}‚Ä¶`, 'info', 'transferStatus');
                const tx = await contract.connect(signer).transferOwnership(addr);
                showStatus(`Tx sent: ${tx.hash}`, 'info', 'transferStatus');
                const rcpt = await tx.wait();
                showStatus(`‚úÖ Ownership transferred to ${addr}`, 'success', 'transferStatus');
                document.getElementById('newOwnerInput').value = '';
                await refreshData();
            } catch (e) {
                if (e.message.includes('Only owner')) showStatus('‚ùå Only owner can transfer', 'error', 'transferStatus');
                else if (e.code === 4001) showStatus('Tx cancelled', 'warning', 'transferStatus');
                else showStatus('Tx failed: ' + e.message, 'error', 'transferStatus');
            }
        }
        async function getEvents() {
            if (!isConnected || !contract) { showStatus('Connect wallet first', 'error', 'events'); return; }
            try {
                showStatus('Loading events‚Ä¶', 'info', 'events');
                const filter = contract.filters.NumberStored();
                const evs = await contract.queryFilter(filter, -1000);
                let html = '';
                if (evs.length === 0) html = '<div class="status info">No events in last 1000 blocks</div>';
                else {
                    html = `<h4 style="margin-bottom:15px">Found ${evs.length} events (latest 10 shown)</h4>`;
                    evs.reverse().slice(0, 10).forEach(ev => {
                        const d = new Date(ev.args.timestamp * 1000);
                        html += `<div class="event-item"><h5>Event</h5>
                            <p><strong>Value:</strong> ${ev.args.newValue.toString()}</p>
                            <p><strong>By:</strong> ${ev.args.setter}</p>
                            <p><strong>Time:</strong> ${d.toLocaleString()}</p>
                            <p><strong>Block:</strong> ${ev.blockNumber}</p>
                            <p><strong>Tx:</strong> ${ev.transactionHash}</p></div>`;
                    });
                }
                document.getElementById('events').innerHTML = html;
            } catch (e) { showStatus('Events failed: ' + e.message, 'error', 'events'); }
        }

        /* =====  QUICK TEST CALLS  ===== */
        async function testRetrieve() { await testCall('retrieve', 'retrieve()'); }
        async function testNumber() { await testCall('number', 'number()'); }
        async function testOwner() { await testCall('owner', 'owner()'); }
        async function testGetContractInfo() {
            try {
                const [num, own, bal] = await contract.getContractInfo();
                showFunctionResult(`getContractInfo()<br>Number: ${num.toString()}<br>Owner: ${own}<br>Balance: ${ethers.utils.formatEther(bal)} ETH`);
            } catch (e) { showFunctionResult('getContractInfo() failed: ' + e.message, 'error'); }
        }
        async function testCall(fn, label) {
            if (!isConnected || !contract) { showFunctionResult('Connect wallet first', 'error'); return; }
            try { const r = await contract[fn](); showFunctionResult(`${label} ‚Üí ${r.toString()}`); } catch (e) { showFunctionResult(`${label} failed: ` + e.message, 'error'); }
        }
        function showFunctionResult(msg, cls = 'success') {
            const el = document.getElementById('functionResults');
            if (el) el.innerHTML = `<div class="status ${cls}">${msg}</div>`;
        }

        /* =====  UI HELPERS  ===== */
        function showStatus(msg, type, elmId) {
            const el = document.getElementById(elmId);
            if (el) {
                el.innerHTML = `<div class="status ${type}">${msg}</div>`;
                if (type === 'success') setTimeout(() => el.innerHTML = '', 5000);
            }
        }

        /* =====  WALLET EVENTS  ===== */
        if (typeof window.ethereum !== 'undefined') {
            window.ethereum.on('accountsChanged', accs => { if (accs.length === 0) disconnectWallet(); else location.reload(); });
            window.ethereum.on('chainChanged', () => location.reload());
            window.ethereum.on('disconnect', () => disconnectWallet());
        }

        /* =====  KEYBOARD SHORTCUTS  ===== */
        document.addEventListener('keydown', e => {
            if (e.ctrlKey || e.metaKey) {
                if (e.key === 'r') { e.preventDefault(); if (!document.getElementById('refreshBtn').disabled) refreshData(); }
            }
            if (e.key === 'Enter' && e.target.tagName === 'INPUT') {
                e.preventDefault();
                if (e.target.id === 'storeInput') storeValue();
                if (e.target.id === 'newOwnerInput') transferOwnership();
            }
        });

        /* =====  AUTO-REFRESH  ===== */
        setInterval(() => { if (isConnected && contract) refreshData(); }, 30000);

        console.log('üöÄ Storage V2 DApp initialised ‚Äì Giwa Sepolia ready');
    </script>
</body>
</html>
